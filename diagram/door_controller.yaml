title: "FamiLAB Door Controller - Raspberry Pi Zero W Wiring"
# Wiring diagram for the FamiLAB Door Controller. Components:
# - Raspberry Pi Zero W (40-pin header)
# - PN532 RFID Reader (I2C)
# - 12V Relay module (controlled by GPIO)
# - 12V → 5V buck converter
# - 12V door latch (powered via relay)
# - 12V power supply
# - 2 x Push buttons (unlock, lock)
# - 3D printed enclosure (mechanical)
# Pi Zero W shares the same 40-pin GPIO header as Pi 4; pinviz uses the `raspberry_pi_4` board template
board: "raspberry_pi_4"
show_legend: true

devices:
  - type: "i2c_device"
    name: "PN532 NFC Reader"
    description: "PN532 NFC RFID reader (I2C)."

  - name: "Relay Module"
    description: "5V relay module controlling a 12V load (COM/NO/NC)."
    pins:
      - name: "VCC"
        role: "5V"
      - name: "GND"
        role: "GND"
      - name: "IN"
        role: "GPIO"
      - name: "COM"
        role: "5V"
      - name: "NO"
        role: "5V"
      - name: "NC"
        role: "5V"

  - type: "button"
    name: "Unlock Button"

  - type: "button"
    name: "Lock Button"

  - name: "12V Power Supply"
    description: "External 12V supply for latch and converter."
    pins:
      - name: "12V"
        role: "5V"
      - name: "GND"
        role: "GND"

  - name: "12V to 5V Buck Converter"
    description: "Buck converter (12V → 5V / 3.3V)."
    pins:
      - name: "VIN"
        role: "5V"
      - name: "GND_IN"
        role: "GND"
      - name: "VOUT"
        role: "3V3"
      - name: "GND_OUT"
        role: "GND"

  - name: "12V Door Latch"
    description: "Door latch/strike (12V)."
    pins:
      - name: "POWER"
        role: "5V"
      - name: "GND"
        role: "GND"

  - name: "3D Printed Case"
    description: "Mechanical enclosure"
    pins:
      - name: "mount"
        role: "GPIO"

connections:
  # PN532 NFC Reader (I2C) - powered from buck converter
  - from: {device: "12V to 5V Buck Converter", device_pin: "VOUT"}
    to:   {device: "PN532 NFC Reader", device_pin: "VCC"}

  - from: {device: "12V to 5V Buck Converter", device_pin: "GND_OUT"}
    to:   {device: "PN532 NFC Reader", device_pin: "GND"}

  - board_pin: 3       # GPIO2 (I2C SDA)
    device: "PN532 NFC Reader"
    device_pin: "SDA"

  - board_pin: 5       # GPIO3 (I2C SCL)
    device: "PN532 NFC Reader"
    device_pin: "SCL"

  # Relay Module (GPIO 17 = physical pin 11)
  - board_pin: 11      # GPIO17 - Relay control signal
    device: "Relay Module"
    device_pin: "IN"

  - board_pin: 9       # GND
    device: "Relay Module"
    device_pin: "GND"

  # Unlock Button (GPIO 27 = physical pin 13)
  - board_pin: 13      # GPIO27
    device: "Unlock Button"
    device_pin: "SIG"

  - board_pin: 14      # GND
    device: "Unlock Button"
    device_pin: "GND"

  # Lock Button (GPIO 22 = physical pin 15)
  - board_pin: 15      # GPIO22
    device: "Lock Button"
    device_pin: "SIG"

  - board_pin: 20      # GND
    device: "Lock Button"
    device_pin: "GND"

  # Power and device-to-device connections
  - from: {device: "12V Power Supply", device_pin: "12V"}
    to:   {device: "Relay Module", device_pin: "COM"}

  - from: {device: "Relay Module", device_pin: "NO"}
    to:   {device: "12V Door Latch", device_pin: "POWER"}

  - from: {device: "12V Power Supply", device_pin: "GND"}
    to:   {device: "12V Door Latch", device_pin: "GND"}

  - from: {device: "12V Power Supply", device_pin: "12V"}
    to:   {device: "12V to 5V Buck Converter", device_pin: "VIN"}

  - from: {device: "12V to 5V Buck Converter", device_pin: "VOUT"}
    to:   {device: "PN532 NFC Reader", device_pin: "VCC"}

  - from: {device: "12V to 5V Buck Converter", device_pin: "GND_OUT"}
    to:   {device: "PN532 NFC Reader", device_pin: "GND"}

# Notes (moved to comments because top-level 'notes' is not supported by PinViz schema):
# CONFIG:
#   RELAY_PIN: 17  # Relay control pin for the door latch
#   BUTTON_UNLOCK_PIN: 27  # Unlock button pin
#   BUTTON_LOCK_PIN: 22  # Lock button pin
#
# EXAMPLE CODE:
#   import RPi.GPIO as GPIO
#   GPIO.setmode(GPIO.BCM)
#   GPIO.setup(RELAY_PIN, GPIO.OUT)
#   GPIO.setup(BUTTON_UNLOCK_PIN, GPIO.IN, pull_up_down=GPIO.PUD_UP)
#   GPIO.setup(BUTTON_LOCK_PIN, GPIO.IN, pull_up_down=GPIO.PUD_UP)
#
#   # Initially, keep the relay off (door locked)
#   GPIO.output(RELAY_PIN, GPIO.LOW)
#
#   import busio, board
#   from adafruit_pn532.i2c import PN532_I2C
#   i2c = busio.I2C(board.SCL, board.SDA)
#   pn532 = PN532_I2C(i2c, debug=False)
#   pn532.SAM_configuration()
#   logger.info("PN532 RFID reader initialized")
#
# POWER NOTES:
#   - Relay switches 12V from the power supply to the door latch.
#   - Buck converter can supply 5V/3.3V as needed for peripherals.
